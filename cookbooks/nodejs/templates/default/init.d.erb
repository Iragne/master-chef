#! /bin/bash

### BEGIN INIT INFO
# Provides:   <%= @name %>
# Required-Start:
# Required-Stop:
# Default-Start:  2 3 4 5
# Default-Stop:
# Short-Description:  <%= @name %>
### END INIT INFO

set -e

SCRIPT="<%= @app_path %>/<%= @script %>"
NAME="<%= @name %>"
DESC="node"
PID_FILE="<%= @pid_file %>"
START_STOP_DAEMON="/sbin/start-stop-daemon"
DAEMON="<%= @runner %>"

test -f $SCRIPT || exit 0
test -x $DAEMON || exit 0

umask 022

. /lib/lsb/init-functions

status_nodejs() {
  status_of_proc -p "$PID_FILE" "node" "$NAME"
}

kill_nodejs() {
  SIGNAL=$1

	if [ ! "$PID_FILE" = "" ]; then
		if [ -f $PID_FILE ]; then
			kill $SIGNAL `cat $PID_FILE` || true
    fi
	fi
}

start_nodejs() {
  SUDO=""
  if [ "$USER" != "<%= @user %>" ]; then
    SUDO="sudo -u <%= @user %>"
  fi

  $SUDO $START_STOP_DAEMON --background --chdir <%= @app_path %> --start --pidfile $PID_FILE --make-pidfile --exec $DAEMON -- $SCRIPT
  sleep 2
  status_nodejs
}

case "$1" in
  start)
    echo -n "Starting $DESC: "
    start_nodejs
    echo "$NAME."
    ;;
  stop)
    echo -n "Stopping $DESC: "
    kill_nodejs
    echo "$NAME."
    ;;
  restart)
    echo -n "Restarting $DESC: "
    kill_nodejs || true
    sleep 1
    start_nodejs
    echo "$NAME."
    ;;
  status)
    status_nodejs
    ;;
  *)
    echo "Usage: /etc/init.d/<%= @name %> {start|stop|restart|status}"
    exit 1
esac

exit 0
